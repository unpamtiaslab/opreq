name: FULL Security Audit (Static Site) + Artifact

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security-audit:
    runs-on: ubuntu-latest

    steps:
    - name: Initialize security report
      run: echo "=== SECURITY AUDIT REPORT ===" > security-report.txt

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 25

    - name: Install dependencies (optional)
      run: npm install || true

    - name: Run ESLint
      run: |
        echo "=== ESLINT OUTPUT ===" >> security-report.txt
        npx eslint script >> security-report.txt 2>&1 || echo "ESLint not configured" >> security-report.txt

    - name: Scan DOM-XSS sinks (native)
      run: |
        echo "\n=== DOM-XSS SINK SCAN (Native DOM) ===" >> security-report.txt
        grep -RInE \
        "document\.write|document\.writeln|document\.domain|innerHTML|outerHTML|insertAdjacentHTML|onevent|eval|setTimeout|setInterval|new Function|execScript" script/ \
        >> security-report.txt 2>&1 || echo "No native DOM-XSS sinks found" >> security-report.txt

    - name: Scan DOM-XSS sinks (jQuery)
      run: |
        echo "\n=== DOM-XSS SINK SCAN (jQuery) ===" >> security-report.txt
        grep -RInE \
        "add\(|after\(|append\(|animate\(|insertAfter\(|insertBefore\(|before\(|html\(|prepend\(|replaceAll\(|replaceWith\(|wrap\(|wrapInner\(|wrapAll\(|jQuery\.parseHTML|\$\.parseHTML" script/ \
        >> security-report.txt 2>&1 || echo "No jQuery XSS sinks found" >> security-report.txt

    - name: Scan for unsafe API usage
      run: |
        echo "\n=== UNSAFE API USAGE SCAN ===" >> security-report.txt
        grep -RInE \
        "localStorage|sessionStorage|indexedDB|postMessage|crypto\.subtle|fetch\(|XMLHttpRequest|WebSocket" script/ \
        >> security-report.txt 2>&1 || echo "No unsafe APIs found" >> security-report.txt

    - name: Check HTML security headers
      run: |
        echo "\n=== HTML SECURITY HEADER CHECK ===" >> security-report.txt
        for header in "Content-Security-Policy" "X-Frame-Options" "X-Content-Type-Options" "Referrer-Policy"; do
          if grep -RIn "$header" index.html >/dev/null; then
            echo "✔ Found: $header" >> security-report.txt
          else
            echo "❌ Missing: $header" >> security-report.txt
          fi
        done

    - name: Check inline scripts/styles
      run: |
        echo "\n=== INLINE JS/CSS CHECK ===" >> security-report.txt
        grep -RIn "<script>" index.html >> security-report.txt 2>&1 || echo "No inline <script>" >> security-report.txt
        grep -RIn "style=" index.html >> security-report.txt 2>&1 || echo "No inline style attributes" >> security-report.txt

    - name: Validate manifest.json
      run: |
        echo "\n=== MANIFEST VALIDATION ===" >> security-report.txt
        node -e "
        try{
          const fs=require('fs');
          const m = JSON.parse(fs.readFileSync('manifest.json'));
          if(!m.name) console.log('❌ Manifest missing name');
          else console.log('✔ Manifest name OK');
          if(!m.start_url) console.log('❌ Manifest missing start_url');
          else console.log('✔ Manifest start_url OK');
        } catch(e){ console.log('❌ Manifest is invalid'); }
        " >> security-report.txt

    - name: Check service worker sw.js
      run: |
        echo "\n=== SERVICE WORKER CHECK ===" >> security-report.txt
        if grep -RIn "skipWaiting" sw.js; then echo "⚠ skipWaiting found" >> security-report.txt; fi
        if grep -RIn "fetch" sw.js; then echo "✔ fetch handler present" >> security-report.txt; fi

    - name: Analyze robots.txt
      run: |
        echo "\n=== ROBOTS.TXT ANALYSIS ===" >> security-report.txt
        if grep -RIn "Allow: /config.json" robots.txt; then
          echo "❌ Sensitive file visible in robots.txt" >> security-report.txt
        else
          echo "✔ robots.txt OK" >> security-report.txt
        fi

    - name: Validate sitemap.xml
      run: |
        echo "\n=== SITEMAP VALIDATION ===" >> security-report.txt
        grep -RIn "<loc>" sitemap.xml >> security-report.txt 2>&1 || echo "❌ No <loc> entries found" >> security-report.txt

    - name: Run npm audit
      run: |
        echo "\n=== NPM AUDIT ===" >> security-report.txt
        npm audit --omit=dev >> security-report.txt 2>&1 || echo "npm audit completed" >> security-report.txt

    - name: Upload security audit artifact
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.txt
