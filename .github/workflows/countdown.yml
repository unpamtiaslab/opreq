name: Countdown Update

on:
  schedule:
    # Update countdown status setiap jam
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-deadline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check countdown deadline
        run: |
          DEADLINE_DATE=$(jq -r '.countdown_deadline.date' config.json)
          DEADLINE_TIME=$(jq -r '.countdown_deadline.time' config.json)
          
          echo "ðŸ“… Deadline: $DEADLINE_DATE $DEADLINE_TIME"
          
          DEADLINE_DATE_EN=$(echo "$DEADLINE_DATE" | sed \
            -e 's/[Jj]anuari/January/g' \
            -e 's/[Ff]ebruari/February/g' \
            -e 's/[Mm]aret/March/g' \
            -e 's/[Mm]ei/May/g' \
            -e 's/[Jj]uni/June/g' \
            -e 's/[Jj]uli/July/g' \
            -e 's/[Aa]gustus/August/g' \
            -e 's/[Ss]eptember/September/g' \
            -e 's/[Oo]ktober/October/g' \
            -e 's/[Nn]ovember/November/g' \
            -e 's/[Dd]esember/December/g')
          
          if [ "$DEADLINE_DATE" != "$DEADLINE_DATE_EN" ]; then
            echo "ðŸ”„ Converted to: $DEADLINE_DATE_EN $DEADLINE_TIME"
          fi
          
          DEADLINE_TS=$(date -d "$DEADLINE_DATE_EN $DEADLINE_TIME" +%s 2>/dev/null)
          
          if [ $? -ne 0 ]; then
            echo "âŒ Error: Invalid date format. Please use format like '19 December 2025' or '19 Desember 2025'"
            exit 1
          fi
          
          CURRENT_TS=$(date +%s)
          
          DIFF=$((DEADLINE_TS - CURRENT_TS))
          
          if [ $DIFF -lt 0 ]; then
            echo "â° Deadline has passed!"
            echo "DEADLINE_PASSED=true" >> $GITHUB_ENV
            echo "STATUS_MESSAGE=âš ï¸ Pendaftaran telah ditutup" >> $GITHUB_ENV
          else
            DAYS=$((DIFF / 86400))
            HOURS=$(((DIFF % 86400) / 3600))
            MINUTES=$(((DIFF % 3600) / 60))
            echo "â³ Time remaining: $DAYS days, $HOURS hours, $MINUTES minutes"
            echo "DEADLINE_PASSED=false" >> $GITHUB_ENV
            echo "DAYS_REMAINING=$DAYS" >> $GITHUB_ENV
            echo "HOURS_REMAINING=$HOURS" >> $GITHUB_ENV
            echo "MINUTES_REMAINING=$MINUTES" >> $GITHUB_ENV
            echo "STATUS_MESSAGE=â³ Waktu tersisa: $DAYS hari, $HOURS jam, $MINUTES menit" >> $GITHUB_ENV
          fi

      - name: Update deadline status file
        run: |
          # Create or update status file with current deadline status
          echo "${{ env.STATUS_MESSAGE }}" > DEADLINE_STATUS.txt
          echo "" >> DEADLINE_STATUS.txt
          
          # Waktu update dalam zona waktu Indonesia
          echo "Last updated:" >> DEADLINE_STATUS.txt
          echo "  WIB (UTC+7): $(TZ='Asia/Jakarta' date '+%Y-%m-%d %H:%M:%S')" >> DEADLINE_STATUS.txt
          echo "  WITA (UTC+8): $(TZ='Asia/Makassar' date '+%Y-%m-%d %H:%M:%S')" >> DEADLINE_STATUS.txt
          echo "  WIT (UTC+9): $(TZ='Asia/Jayapura' date '+%Y-%m-%d %H:%M:%S')" >> DEADLINE_STATUS.txt
          echo "" >> DEADLINE_STATUS.txt
          echo "Deadline passed: ${{ env.DEADLINE_PASSED }}" >> DEADLINE_STATUS.txt
          
          if [ "${{ env.DEADLINE_PASSED }}" = "false" ]; then
            echo "" >> DEADLINE_STATUS.txt
            echo "Sisa waktu:" >> DEADLINE_STATUS.txt
            echo "  ${{ env.DAYS_REMAINING }} hari" >> DEADLINE_STATUS.txt
            echo "  ${{ env.HOURS_REMAINING }} jam" >> DEADLINE_STATUS.txt
            echo "  ${{ env.MINUTES_REMAINING }} menit" >> DEADLINE_STATUS.txt
          fi
          
          cat DEADLINE_STATUS.txt
          
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add DEADLINE_STATUS.txt
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update: Deadline status at $(TZ='Asia/Jakarta' date '+%Y-%m-%d %H:%M:%S WIB')" && git push)
